import React, { useState, useEffect, useMemo } from 'react';
import { 
  ChevronLeft, 
  ChevronRight, 
  Calendar, 
  CheckCircle, 
  AlertCircle, 
  X,
  Trash2,
  Grid,
  Columns,
  List
} from 'lucide-react';

// --- CONFIGURATION ---

const ROOMS = [
  "Sanctuary",
  "Social Hall",
  "The Studio on 3",
  "Youth Room",
  "Studio on 4",
  "Classroom",
  "Kitchen",
  "Parlor",
  "Podcast Room"
];

const STAFF = [
  "Jacqui Lewis",
  "Rev. Natalie Renee Perkins",
  "Macky Alston",
  "Rev. Amanda Hambrick Ashcraft",
  "Elise Tiralli",
  "John del Cueto",
  "Zayn D. Silva",
  "Michael Lennon",
  "Joseph Puma"
];

const HOURS = { start: 7, end: 22 };

// --- STORAGE API (Using Artifact Persistent Storage) ---

const storage = {
  getReservations: async (room) => {
    try {
      const result = await window.storage.get(`reservations:${room}`, true);
      return result ? JSON.parse(result.value) : [];
    } catch (error) {
      console.log('No reservations found for room:', room);
      return [];
    }
  },

  saveReservations: async (room, reservations) => {
    try {
      await window.storage.set(`reservations:${room}`, JSON.stringify(reservations), true);
    } catch (error) {
      console.error('Failed to save reservations:', error);
      throw error;
    }
  }
};

// --- HELPER FUNCTIONS ---

const generateTimeSlots = () => {
  const slots = [];
  for (let i = HOURS.start; i < HOURS.end; i++) {
    slots.push(`${i.toString().padStart(2, '0')}:00`);
    slots.push(`${i.toString().padStart(2, '0')}:30`);
  }
  return slots;
};

const getWeekDays = (baseDate) => {
  const labels = [];
  const day = new Date(baseDate);
  const dayOfWeek = day.getDay();
  const diff = day.getDate() - dayOfWeek;
  const startOfWeek = new Date(day.setDate(diff));

  for (let i = 0; i < 7; i++) {
    const d = new Date(startOfWeek);
    d.setDate(startOfWeek.getDate() + i);
    labels.push(d);
  }
  return labels;
};

const getMonthDays = (baseDate) => {
  const year = baseDate.getFullYear();
  const month = baseDate.getMonth();
  
  const firstDay = new Date(year, month, 1);
  const startOffset = firstDay.getDay();
  const startDate = new Date(firstDay);
  startDate.setDate(firstDay.getDate() - startOffset);
  
  const days = [];
  for (let i = 0; i < 42; i++) {
    const d = new Date(startDate);
    d.setDate(startDate.getDate() + i);
    days.push(d);
  }
  return days;
};

const formatDateForInput = (dateObj) => {
  return dateObj.toISOString().split('T')[0];
};

const timeToMinutes = (timeStr) => {
  const [h, m] = timeStr.split(':').map(Number);
  return h * 60 + m;
};

const generateId = () => {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
};

// --- COMPONENTS ---

const Header = ({ title }) => (
  <header className="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between sticky top-0 z-20 shadow-sm">
    <div className="flex items-center gap-3">
      <div className="bg-indigo-900 text-white p-2 rounded-lg">
        <Calendar size={24} />
      </div>
      <div>
        <h1 className="text-xl font-bold text-gray-900">Middle Collegiate Church</h1>
        <p className="text-sm text-gray-500">{title}</p>
      </div>
    </div>
    <div className="flex items-center gap-4 text-sm">
      <div className="flex items-center gap-2">
        <div className="w-3 h-3 rounded-full bg-red-500"></div>
        <span>Booked</span>
      </div>
      <div className="flex items-center gap-2">
        <div className="w-3 h-3 rounded-full bg-amber-400"></div>
        <span>Inquiry</span>
      </div>
      <div className="flex items-center gap-2">
        <div className="w-3 h-3 rounded-full bg-emerald-50 border border-emerald-200"></div>
        <span>Available</span>
      </div>
    </div>
  </header>
);

const RoomSelector = ({ selectedRoom, onSelect }) => (
  <div className="mb-4">
    <label className="block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1">
      Select Space
    </label>
    <select 
      value={selectedRoom} 
      onChange={(e) => onSelect(e.target.value)}
      className="w-full p-2.5 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-medium text-gray-700"
    >
      {ROOMS.map(room => (
        <option key={room} value={room}>{room}</option>
      ))}
    </select>
  </div>
);

const ViewSwitcher = ({ viewMode, onViewChange }) => (
  <div className="flex p-1 bg-gray-100 rounded-lg mb-4">
    <button
      onClick={() => onViewChange('month')}
      className={`flex-1 py-1.5 text-xs font-medium rounded-md flex items-center justify-center gap-1 transition-all ${viewMode === 'month' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
    >
      <Grid size={14} /> Month
    </button>
    <button
      onClick={() => onViewChange('week')}
      className={`flex-1 py-1.5 text-xs font-medium rounded-md flex items-center justify-center gap-1 transition-all ${viewMode === 'week' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
    >
      <Columns size={14} /> Week
    </button>
    <button
      onClick={() => onViewChange('day')}
      className={`flex-1 py-1.5 text-xs font-medium rounded-md flex items-center justify-center gap-1 transition-all ${viewMode === 'day' ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
    >
      <List size={14} /> Day
    </button>
  </div>
);

const DateControls = ({ currentDate, onPrev, onNext, onToday, viewMode }) => {
  let dateLabel = '';
  if (viewMode === 'month') {
    dateLabel = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  } else if (viewMode === 'day') {
    dateLabel = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
  } else {
    const start = new Date(currentDate);
    start.setDate(start.getDate() - start.getDay());
    const end = new Date(start);
    end.setDate(end.getDate() + 6);
    
    if (start.getMonth() === end.getMonth()) {
      dateLabel = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    } else {
      dateLabel = `${start.toLocaleDateString('en-US', { month: 'short' })} - ${end.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}`;
    }
  }

  return (
    <div className="flex items-center justify-between mb-4 bg-gray-50 p-2 rounded-lg border border-gray-200">
      <button onClick={onPrev} className="p-1 hover:bg-white hover:shadow rounded transition-all text-gray-600">
        <ChevronLeft size={20} />
      </button>
      <div className="text-center">
        <span className="block text-sm font-semibold text-gray-900">
          {dateLabel}
        </span>
      </div>
      <div className="flex gap-2">
        <button onClick={onToday} className="text-xs px-3 py-1 bg-white border border-gray-300 rounded font-medium text-gray-600 hover:bg-gray-50">
          Today
        </button>
        <button onClick={onNext} className="p-1 hover:bg-white hover:shadow rounded transition-all text-gray-600">
          <ChevronRight size={20} />
        </button>
      </div>
    </div>
  );
};

const ReservationModal = ({ 
  isOpen, 
  onClose, 
  data, 
  onSave, 
  onDelete,
  saving 
}) => {
  const [formData, setFormData] = useState({
    meetingName: '',
    staffName: STAFF[0],
    status: 'inquiry',
    date: '',
    startTime: '09:00',
    endTime: '10:00',
    ...data
  });

  const [error, setError] = useState(null);

  useEffect(() => {
    if (data) setFormData(prev => ({ ...prev, ...data }));
  }, [data]);

  if (!isOpen) return null;

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError(null);
    
    if (timeToMinutes(formData.endTime) <= timeToMinutes(formData.startTime)) {
      setError("End time must be after start time.");
      return;
    }

    try {
      await onSave(formData);
      onClose();
    } catch (err) {
      setError("Failed to save reservation. " + err.message);
    }
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
          <h3 className="text-lg font-bold text-gray-800">
            {formData.id ? 'Edit Reservation' : 'New Reservation'}
          </h3>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
            <X size={20} />
          </button>
        </div>
        
        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          {error && (
            <div className="bg-red-50 text-red-700 p-3 rounded-lg text-sm flex items-start gap-2">
              <AlertCircle size={16} className="mt-0.5 shrink-0" />
              {error}
            </div>
          )}

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Room</label>
            <div className="text-gray-900 font-semibold">{formData.room}</div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Date</label>
              <input 
                type="date" 
                required
                className="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2 border"
                value={formData.date}
                onChange={e => setFormData({...formData, date: e.target.value})}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select 
                className="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2 border"
                value={formData.status}
                onChange={e => setFormData({...formData, status: e.target.value})}
              >
                <option value="inquiry">Inquiry (Yellow)</option>
                <option value="booked">Booked (Red)</option>
              </select>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
              <input 
                type="time" 
                required
                className="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2 border"
                value={formData.startTime}
                onChange={e => setFormData({...formData, startTime: e.target.value})}
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">End Time</label>
              <input 
                type="time" 
                required
                className="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2 border"
                value={formData.endTime}
                onChange={e => setFormData({...formData, endTime: e.target.value})}
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Event Name</label>
            <input 
              type="text" 
              required
              placeholder="e.g. Wedding Rehearsal"
              className="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2 border"
              value={formData.meetingName}
              onChange={e => setFormData({...formData, meetingName: e.target.value})}
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Staff Contact</label>
            <select 
              className="w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2 border"
              value={formData.staffName}
              onChange={e => setFormData({...formData, staffName: e.target.value})}
            >
              {STAFF.map(s => <option key={s} value={s}>{s}</option>)}
            </select>
          </div>

          <div className="pt-4 flex gap-3">
            {formData.id && (
              <button
                type="button"
                onClick={() => {
                  if(confirm('Delete this reservation?')) {
                    onDelete(formData.id);
                    onClose();
                  }
                }}
                className="px-4 py-2 text-sm font-medium text-red-600 bg-red-50 rounded-md hover:bg-red-100 flex items-center gap-2"
              >
                <Trash2 size={16} /> Delete
              </button>
            )}
            <div className="flex-1"></div>
            <button
              type="button"
              onClick={onClose}
              className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              type="submit"
              disabled={saving}
              className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:opacity-50 flex items-center gap-2"
            >
              {saving ? 'Saving...' : 'Save Reservation'}
              {!saving && <CheckCircle size={16} />}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

const MonthView = ({ currentDate, reservations, onSlotClick, onReservationClick }) => {
  const days = useMemo(() => getMonthDays(currentDate), [currentDate]);
  const weeks = [];
  for (let i = 0; i < days.length; i += 7) {
    weeks.push(days.slice(i, i + 7));
  }

  const getReservationsForDay = (date) => {
    const dateStr = formatDateForInput(date);
    return reservations
      .filter(r => r.date === dateStr)
      .sort((a, b) => timeToMinutes(a.startTime) - timeToMinutes(b.startTime));
  };

  return (
    <div className="flex flex-col h-full border border-gray-200 rounded-lg bg-white shadow-sm overflow-hidden">
      <div className="flex border-b border-gray-200 bg-gray-50">
        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
          <div key={d} className="flex-1 py-2 text-center text-xs font-semibold text-gray-500 uppercase">
            {d}
          </div>
        ))}
      </div>
      
      <div className="flex-1 grid grid-rows-6">
        {weeks.map((week, wIndex) => (
          <div key={wIndex} className="grid grid-cols-7 border-b border-gray-100 last:border-0 min-h-[100px]">
            {week.map((day, dIndex) => {
              const isToday = new Date().toDateString() === day.toDateString();
              const isCurrentMonth = day.getMonth() === currentDate.getMonth();
              const dayRes = getReservationsForDay(day);

              return (
                <div 
                  key={dIndex} 
                  className={`border-r border-gray-100 last:border-0 p-1 relative flex flex-col gap-1 transition-colors hover:bg-gray-50 cursor-pointer ${!isCurrentMonth ? 'bg-gray-50/50' : 'bg-white'}`}
                  onClick={() => onSlotClick(day, '09:00')}
                >
                  <div className={`text-xs font-medium text-right p-1 ${isToday ? 'bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center ml-auto shadow-sm' : isCurrentMonth ? 'text-gray-700' : 'text-gray-400'}`}>
                    {day.getDate()}
                  </div>
                  <div className="flex flex-col gap-1 overflow-y-auto max-h-[80px]">
                    {dayRes.map(res => {
                      const isBooked = res.status === 'booked';
                      const bgClass = isBooked ? 'bg-red-100 text-red-800' : 'bg-amber-100 text-amber-800';
                      return (
                        <div 
                          key={res.id}
                          onClick={(e) => {
                            e.stopPropagation();
                            onReservationClick(res);
                          }}
                          className={`text-[10px] px-1.5 py-0.5 rounded truncate font-medium ${bgClass}`}
                          title={`${res.startTime} - ${res.meetingName}`}
                        >
                          {res.startTime} {res.meetingName}
                        </div>
                      )
                    })}
                  </div>
                </div>
              )
            })}
          </div>
        ))}
      </div>
    </div>
  )
}

const TimeGridView = ({ 
  dates,
  currentDate, 
  room, 
  reservations, 
  onSlotClick, 
  onReservationClick 
}) => {
  const timeSlots = useMemo(() => generateTimeSlots(), []);
  const startHour = HOURS.start;
  const slotHeight = 60;

  const getReservationsForDay = (date) => {
    const dateStr = formatDateForInput(date);
    return reservations.filter(r => r.date === dateStr);
  };

  return (
    <div className="flex flex-col h-full border border-gray-200 rounded-lg bg-white overflow-hidden shadow-sm">
      <div className="flex border-b border-gray-200">
        <div className="w-16 shrink-0 bg-gray-50 border-r border-gray-200"></div>
        {dates.map((day, i) => {
          const isToday = new Date().toDateString() === day.toDateString();
          return (
            <div key={i} className={`flex-1 py-3 text-center border-r border-gray-100 last:border-r-0 ${isToday ? 'bg-indigo-50' : 'bg-gray-50'}`}>
              <div className={`text-xs font-semibold uppercase ${isToday ? 'text-indigo-600' : 'text-gray-500'}`}>
                {day.toLocaleDateString('en-US', { weekday: 'short' })}
              </div>
              <div className={`text-sm font-bold mt-1 ${isToday ? 'text-indigo-900' : 'text-gray-900'}`}>
                {day.getDate()}
              </div>
            </div>
          );
        })}
      </div>

      <div className="flex-1 overflow-y-auto relative h-[600px]">
        <div className="flex min-h-[900px]">
          <div className="w-16 shrink-0 bg-white border-r border-gray-200 flex flex-col">
            {timeSlots.filter(t => t.endsWith(':00')).map(time => (
              <div key={time} className="h-[60px] text-xs text-gray-400 text-right pr-2 pt-1 relative">
                <span className="-top-2 relative">{time}</span>
              </div>
            ))}
          </div>

          {dates.map((day, colIndex) => {
            const daysReservations = getReservationsForDay(day);
            const isToday = new Date().toDateString() === day.toDateString();

            return (
              <div key={colIndex} className={`flex-1 relative border-r border-gray-100 last:border-r-0 ${isToday ? 'bg-indigo-50/30' : ''}`}>
                {timeSlots.filter(t => t.endsWith(':00')).map(time => (
                  <div key={`grid-${time}`} className="h-[60px] border-b border-gray-50 w-full"></div>
                ))}

                <div className="absolute inset-0 z-0">
                  {timeSlots.map((time, slotIndex) => (
                    <div 
                      key={time}
                      className="h-[30px] w-full hover:bg-gray-100/50 cursor-pointer transition-colors"
                      onClick={() => onSlotClick(day, time)}
                      title={`Click to book ${time}`}
                    ></div>
                  ))}
                </div>

                {daysReservations.map(res => {
                  const startMin = timeToMinutes(res.startTime);
                  const endMin = timeToMinutes(res.endTime);
                  const dayStartMin = startHour * 60;
                  
                  const top = ((startMin - dayStartMin) / 60) * slotHeight;
                  const height = ((endMin - startMin) / 60) * slotHeight;

                  const isBooked = res.status === 'booked';
                  const bgClass = isBooked 
                    ? 'bg-red-100 border-red-300 hover:bg-red-200' 
                    : 'bg-amber-100 border-amber-300 hover:bg-amber-200';
                  const textClass = isBooked ? 'text-red-900' : 'text-amber-900';
                  const borderClass = isBooked ? 'border-l-4 border-l-red-500' : 'border-l-4 border-l-amber-500';

                  return (
                    <div
                      key={res.id}
                      onClick={(e) => {
                        e.stopPropagation();
                        onReservationClick(res);
                      }}
                      className={`absolute left-1 right-1 rounded shadow-sm text-xs p-1.5 cursor-pointer z-10 transition-all overflow-hidden ${bgClass} ${borderClass} border-y border-r`}
                      style={{ top: `${top}px`, height: `${height}px` }}
                    >
                      <div className={`font-bold truncate ${textClass}`}>{res.meetingName}</div>
                      <div className="text-gray-600 truncate text-[10px]">{res.startTime} - {res.endTime}</div>
                      <div className="text-gray-500 truncate text-[10px] italic">{res.staffName}</div>
                    </div>
                  );
                })}
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
};

// --- MAIN APP COMPONENT ---

export default function App() {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [viewMode, setViewMode] = useState('week');
  const [selectedRoom, setSelectedRoom] = useState(ROOMS[0]);
  const [reservations, setReservations] = useState([]);
  const [loading, setLoading] = useState(true);
  const [modalOpen, setModalOpen] = useState(false);
  const [currentReservation, setCurrentReservation] = useState(null);
  const [isSaving, setIsSaving] = useState(false);

  // Load reservations
  useEffect(() => {
    const loadReservations = async () => {
      setLoading(true);
      try {
        const data = await storage.getReservations(selectedRoom);
        setReservations(data);
      } catch (error) {
        console.error('Error loading reservations:', error);
      } finally {
        setLoading(false);
      }
    };
    
    loadReservations();
  }, [selectedRoom]);

  const handlePrev = () => {
    const newDate = new Date(currentDate);
    if (viewMode === 'month') {
      newDate.setMonth(newDate.getMonth() - 1);
    } else if (viewMode === 'day') {
      newDate.setDate(newDate.getDate() - 1);
    } else {
      newDate.setDate(newDate.getDate() - 7);
    }
    setCurrentDate(newDate);
  };

  const handleNext = () => {
    const newDate = new Date(currentDate);
    if (viewMode === 'month') {
      newDate.setMonth(newDate.getMonth() + 1);
    } else if (viewMode === 'day') {
      newDate.setDate(newDate.getDate() + 1);
    } else {
      newDate.setDate(newDate.getDate() + 7);
    }
    setCurrentDate(newDate);
  };

  const handleSlotClick = (date, startTime) => {
    const [h, m] = startTime.split(':').map(Number);
    let endH = h;
    let endM = m + 30;
    if (endM >= 60) {
      endH++;
      endM = 0;
    }
    const endTime = `${endH.toString().padStart(2, '0')}:${endM.toString().padStart(2, '0')}`;

    setCurrentReservation({
      room: selectedRoom,
      date: formatDateForInput(date),
      startTime,
      endTime,
      meetingName: '',
      staffName: STAFF[0],
      status: 'inquiry'
    });
    setModalOpen(true);
  };

  const handleEditReservation = (res) => {
    setCurrentReservation(res);
    setModalOpen(true);
  };

  const handleSaveReservation = async (data) => {
    setIsSaving(true);
    try {
      const sameDay = reservations.filter(r => 
        r.date === data.date && r.id !== data.id
      );

      const newStart = timeToMinutes(data.startTime);
      const newEnd = timeToMinutes(data.endTime);

      const hasConflict = sameDay.some(r => {
        const existStart = timeToMinutes(r.startTime);
        const existEnd = timeToMinutes(r.endTime);
        const overlap = newStart < existEnd && existStart < newEnd;
        if (overlap) {
          if (r.status === 'booked' && data.status === 'booked') return true;
        }
        return false; 
      });

      if (hasConflict) {
        throw new Error("This time slot is already fully booked.");
      }

      let updatedReservations;
      if (data.id) {
        updatedReservations = reservations.map(r => r.id === data.id ? data : r);
      } else {
        const newReservation = { ...data, id: generateId() };
        updatedReservations = [...reservations, newReservation];
      }

      await storage.saveReservations(selectedRoom, updatedReservations);
      setReservations(updatedReservations);
    } finally {
      setIsSaving(false);
    }
  };

  const handleDelete = async (id) => {
    if (id) {
      const updatedReservations = reservations.filter(r => r.id !== id);
      await storage.saveReservations(selectedRoom, updatedReservations);
      setReservations(updatedReservations);
    }
  };

  const renderView = () => {
    if (viewMode === 'month') {
      return (
        <MonthView 
          currentDate={currentDate}
          reservations={reservations}
          onSlotClick={handleSlotClick}
          onReservationClick={handleEditReservation}
        />
      );
    }

    const days = viewMode === 'day' ? [currentDate] : getWeekDays(currentDate);

    return (
      <TimeGridView 
        dates={days}
        currentDate={currentDate}
        room={selectedRoom}
        reservations={reservations}
        onSlotClick={handleSlotClick}
        onReservationClick={handleEditReservation}
      />
    );
  };

  return (
    <div className="min-h-screen bg-gray-50 text-gray-900 font-sans">
      <Header title="Room Reservations" />
      
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
          <div className="lg:col-span-1 space-y-6">
            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
              <RoomSelector selectedRoom={selectedRoom} onSelect={setSelectedRoom} />
              
              <ViewSwitcher viewMode={viewMode} onViewChange={setViewMode} />

              <DateControls 
                currentDate={currentDate} 
                onPrev={handlePrev} 
                onNext={handleNext} 
                onToday={() => setCurrentDate(new Date())}
                viewMode={viewMode}
              />

              <div className="mt-6 pt-6 border-t border-gray-100">
                <h4 className="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">
                  Instructions
                </h4>
                <ul className="text-sm text-gray-600 space-y-2">
                  <li className="flex gap-2">
                    <span className="text-indigo-500">•</span>
                    Select a room to view its schedule.
                  </li>
                  <li className="flex gap-2">
                    <span className="text-indigo-500">•</span>
                    Click any empty slot to create a reservation.
                  </li>
                  <li className="flex gap-2">
                    <span className="text-indigo-500">•</span>
                    Click an existing block to edit details.
                  </li>
                </ul>
              </div>
            </div>

            <div className="bg-slate-800 p-4 rounded-xl shadow-sm text-slate-300 text-xs">
              <h4 className="font-bold text-white mb-2 flex items-center gap-2">
                <div className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                Persistent Storage
              </h4>
              <p>Using artifact storage.</p>
              <p className="mt-2 text-slate-400">
                Data is shared across all users and persists between sessions.
              </p>
            </div>
          </div>

          <div className="lg:col-span-3 h-[800px]">
            {loading ? (
              <div className="h-full flex items-center justify-center bg-white rounded-lg border border-gray-200">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
              </div>
            ) : renderView()}
          </div>
        </div>
      </main>

      <ReservationModal 
        isOpen={modalOpen}
        onClose={() => setModalOpen(false)}
        data={currentReservation}
        onSave={handleSaveReservation}
        onDelete={handleDelete}
        saving={isSaving}
      />
    </div>
  );
}